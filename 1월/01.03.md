# Docker Swarm 

* 도커 레지스트리용 이미지 생성

```bash
$ docker tag example/echo:latest localhost:5000/echo/example/echo:latest
```

*  도커 레지스트리에 이미지 푸쉬 

```bash
$ docker push localhost:5000/echo/example/echo:latest
```

*  dind중 worker에 해당이미지 다운로드

```bash
$ docker exec -it worker01 sh
docker pull registry:5000/example/echo:latest

#docker exec -it worker01 docker pull registry:5000/example/echo:latest 한줄입력할때
```

# Docker service

*  service 

-애플리케이션을 구상하는 일부 컨테이너(단일 또는 복수)를 제어하기 위한 단위



```bash
$ docker exec -it manager \
	docker service create --replicas 1 --publish 8000:8080 --name echo\
	registry:5000/example/echo:latest
	
$ docker exec -it manager docker service ls
$ docker exec -it manager docker service scale echo=6 # 컨테이너수를 늘릴수있음,scale in/out
$ docker exec -it manager docker service ps echo # 특정 서비스이름을 지정해줘야함
$ docker exec -it manager docker service rm echo
```

# Docker Stack

-하나 이상의 서비스를 그룹으로 묶은 단위, 애플리케이션 전체 구성 정의

​	-서비스는 애플리케이션 이미지를 하나 밖에 다루지 못함

-여러 서비스를 함께 다룰 수 있음

-스택을 사용해 배포된 서비스 그룹은 overlay 네트워크에 속함

> 여러컨테이너 ==> 서비스 , 여러서비스 ==> 스택

```bash
$ docker exec -it manager docker network create --driver=overlay --attachable ch03
```

* 스택 yml 작성

```bash
version: "3"
services:
    nginx:
        image: gihyodocker/nginx-proxy
        deploy:
            replicas: 3
            placement:
                constraints: [node.role !=manager]
        enviroment:
            BACKEND_HOST: echo_api:8080
        depends_on:
            - api
        networks:
            - ch03
    api:
        image: registry:5000/example/echo:latest
        deploy:
            replicas: 3
            placement:
                constraints: [node.role !=manager]
        networks:
            - ch03
networks:
    ch03:
        external: true
```

* 스택 배포하기

```bash
$ docker stack deploy -c /stack/ch03-webapi.yml echo #스택명을 echo라고 지음
```

* 배포된 스택확인하기

```bash
$ docker stack services echo # 스택명
```

* 스택에 배포된 컨테이너 확인하기

```bash
$ docker stack ps echo # 스택명
```

*  스택 삭제

```bash
$ docker stack rm echo # 스택명
```



## Visualizer를 사용해 컨테이너 배치 시각화하기

* visualizer.yml 파일 생성

```bash
version: "3"
services:
    app:
        image: dockersamples/visualizer
        ports:
            - "9000:8080"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        deploy:
            mode: global
            placement:
                constraints: [node.role == manager]
```

* 스택  배포

```bash
$ docker stack deploy -c /stack/visualizer.yml visualizer #manager 들어가서
```